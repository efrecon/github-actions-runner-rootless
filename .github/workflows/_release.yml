on:
  workflow_call:
    inputs:
      project:
        required: true
        type: string
        description: |
          Name of the source project to follow versioning for, e.g. `moby/moby`
      image:
        required: true
        type: string
        description: |
          Name of the (internal) image to generate, e.g. `ubuntu-dind`.
      action:
        required: true
        type: string
        description: |
          Name of the action to use for generating the image
    secrets:
      username:
        required: false
        description: Username for access at the DockerHub
      password:
        required: false
        description: Password/token for access at the DockerHub
    # outputs:
    #   version:
    #     description: The latest released version of the project
    #     value: ${{ jobs.build.outputs.version }}

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.semver.outputs.version }}
    env:
      HAVE_ACCESS: ${{ secrets.username != '' }}
    steps:
      - name: Check out the repo
        uses: actions/checkout@v2

      - name: Release Version
        id: semver
        uses: ./.github/actions/version
        with:
          project: ${{ inputs.project }}

      # Publish containers to the GHCR tagged with the latest version, if they
      # do not already exist.
      - name: Login to GHCR
        uses: docker/login-action@v1
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Check Images Presence
        shell: bash
        id: ghcr
        run: |
          if docker image pull -q ghcr.io/${{ github.repository }}/${{ inputs.image }}:${{ steps.semver.outputs.version }}; then
            echo "::set-output name=present::true"
          else
            echo "::set-output name=present::false"
          fi
      - name: Publish Images to GHCR
        if: steps.ghcr.outputs.present == 'false'
        uses: ${{ inputs.action }}
        with:
          registry: ghcr.io/${{ github.repository }}
          version: ${{ steps.semver.outputs.version }}

      # Publish containers to the DockerHub tagged with the latest version. This
      # only happens if a DOCKERHUB_USERNAME is set.
      - name: Login to DockerHub
        if: env.HAVE_ACCESS == 'true'
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.username }}
          password: ${{ secrets.password }}
      - name: Check Images Presence
        if: env.HAVE_ACCESS == 'true'
        shell: bash
        id: dockerhub
        run: |
          if docker image pull -q ${{ github.repository_owner }}/${{ inputs.image }}:${{ steps.semver.outputs.version }}; then
            echo "::set-output name=present::true"
          else
            echo "::set-output name=present::false"
          fi
      - name: Publish Images to DockerHub
        if: env.HAVE_ACCESS == 'true' && steps.dockerhub.outputs.present == 'false'
        uses: ${{ inputs.action }}
        with:
          registry: ${{ github.repository_owner }}
          version: ${{ steps.semver.outputs.version }}